---
title: "Time Window Analysis"
author: "windowing team"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Motivation

(Peelle and Van Engen (2020))[https://psyarxiv.com/pc3da/] style multiverse analysis considering possible time windows with logistic growth curve models in a dataset with words of varying frequency, stimuli with varying levels of noise, and with young or old adults. 

```{r load-data}
# get local copy by running peekbank_explore.Rmd
load("data/aoi_data_joined.Rds")

library(tidyverse)
library(lme4)
library(lmerTest)
library(tictoc)
library(langcog)
library(here)
library(broom.mixed) # offers tidy() for lmer
library(doParallel)
library(foreach)

RUN_MODELS = FALSE
```

For our analysis, we will restrict ourselves to familiar words, and will model age effects.

```{r}
df <- aoi_data_joined %>%
  filter(stimulus_novelty=="familiar", # just familiar, or is the goal to distinguish novel vs. familiar?
         !is.na(age)) 

rm(aoi_data_joined)
```


## Run Window Models


```{r, eval=RUN_MODELS}
# t_norm = [-1000,3000]
window_min <- -300 # 300 ms before disambiguation
window_max <- 2300 #

# Time bins are 25 ms 
startTimes <- seq(from = window_min, to = window_max, by = 25) 
# could use min(pb datasets min time) and max(pb datasets max time)
windowLengths <- seq(from = 300, to = 1800, by = 25)

param.grid <- expand.grid(startTimes, windowLengths)
names(param.grid) = c("startTimes", "windowLengths")

numCores <- 5
cl <- makeCluster(numCores)
registerDoParallel(cores=numCores)

# for testing
#mout <- foreach(i = 1:20, .combine='bind_rows') %dopar% { 
# for reals
mout <- foreach(i = 1:nrow(param.grid), .combine='bind_rows') %dopar% {
    # by-trial means
    dft <- df %>% filter(t_norm > param.grid$startTimes[i], 
                         t_norm < (param.grid$startTimes[i] + param.grid$windowLengths[i])) %>%
      rename(target_label = english_stimulus_label) %>%
      group_by(administration_id, trial_id, target_label, distractor_id, age) %>%
      summarise(prop_looking = sum(aoi == "target", na.rm = TRUE) / 
                  (sum(aoi=="target", na.rm=TRUE) + sum(aoi=="distractor", na.rm=TRUE)),
                prop_missing = mean(aoi == "missing", na.rm = TRUE)) %>%
      filter(prop_missing < .3) %>%
      ungroup() %>%
      mutate(age_center = scale(age, scale = FALSE))
    
    # what basic model do we want to run? or do we need to go logistic growth curve?
    mod <- lmer(prop_looking ~ age_center + (1| administration_id) + (1 | target_label),
           data = dft)
    # save coefficients per model
    tidy(mod, effects="fixed") %>% 
      mutate(startTime = param.grid$startTimes[i], 
             windowLength = param.grid$windowLengths[i])
} 
stopCluster(cl)

write.table(mout, file="data/time-window-results.csv")
```

## Visualization 

```{r load-model-results}
mout <- read.table(file="data/time-window-results.csv")
```


Visualize significance and magnitude of age coefficient as function of start time and window length.
