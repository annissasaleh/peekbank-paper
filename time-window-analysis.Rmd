---
title: "Time Window Analysis"
author: "windowing team"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Motivation

[Peelle and Van Engen (2020)](https://psyarxiv.com/pc3da/) style multiverse analysis considering possible time windows with logistic growth curve models in a dataset with words of varying frequency, stimuli with varying levels of noise, and with young or old adults. 

```{r load-data, echo=F, message=F, warning=F}
# get local copy by running peekbank_explore.Rmd
load("data/aoi_data_joined.Rds") 
# change t_range upper limit to 4000 for full window analysis

library(tidyverse)
library(tictoc)
library(langcog)
library(here)
library(doParallel)
library(foreach)
library(ggpubr)

RUN_MODELS = FALSE
```

For our analysis, we will restrict ourselves to familiar words, and will model age effects.

```{r}
fam_data <- aoi_data_joined %>%
  filter(age > 12, age <= 60, 
         stimulus_novelty == "familiar") %>%
  mutate(age_binned = cut(age, seq(0,60,12))) 

rm(aoi_data_joined)
```


## Run Window Models


```{r, eval=RUN_MODELS}
# t_norm = [-1000,4000] 
get_alpha <- function (df) {
                    dfw <- pivot_wider(df,
                                       names_from = english_stimulus_label,
                                       values_from = prop_corr) %>%
                      select(-administration_id)
                    alphas <- psych::alpha(dfw)
                    return(alphas$total$raw_alpha)
}

# inter-item correlations
get_interitem <- function (df) {
   dfw <- pivot_wider(df,
                      names_from = english_stimulus_label,
                      values_from = prop_corr) %>%
     ungroup() %>%
     select(-administration_id)
   corrs <- corrr::correlate(dfw)
   mean_corr <- mean(rowMeans(select(corrs, -term), na.rm=TRUE), na.rm=TRUE)
   #rm(corrs)
   #gc()
   return(mean_corr)
}


run_grid <- function(fam_dat, outfile) {
  window_min <- -500 # X ms before disambiguation
  window_max <- 2000 #

  # Time bins are 25 ms 
  startTimes <- seq(from = window_min, to = window_max, by = 25) 
  # could use min(pb datasets min time) and max(pb datasets max time)
  windowLengths <- seq(from = 300, to = 2000, by = 25)

  param.grid <- expand.grid(startTimes, windowLengths)
  names(param.grid) = c("startTimes", "windowLengths")
  
  mout <- foreach(i = 1:nrow(param.grid), .combine='bind_rows',
                .packages = c("corrr","tidyverse")) %dopar% {
    
    fam_dat %>% filter(t_norm > param.grid$startTimes[i], 
                         t_norm < (param.grid$startTimes[i] + param.grid$windowLengths[i])) %>%
      group_by(dataset_name, age_binned, administration_id, english_stimulus_label) %>%
      summarise(prop_corr = sum(aoi == "target") /
                  sum(aoi %in% c("target", "distractor"))) %>%
      group_by(dataset_name, age_binned) %>%
      nest() %>%
      mutate(interitem =  lapply(data, quietly(get_interitem)),
             interitem = interitem[[1]]$result) %>%
      select(-data) %>%
      unnest(cols = "interitem") %>%
      group_by(age_binned) %>%
      summarise(mean = mean(interitem, na.rm=TRUE)) %>%
      mutate(startTime = param.grid$startTimes[i],
             windowLength = param.grid$windowLengths[i])
  } 
  write.table(mout, file=paste0("data/",outfile,".csv"))
  return(mout)
}

numCores <- detectCores() - 1
cl <- makeCluster(numCores)
registerDoParallel(cores=numCores)

mout <- run_grid(fam_data, "time-window-results")

stopCluster(cl)
```

## Visualization 

```{r load-model-results, echo=F}
# all data
mout <- read.table(file="data/time-window-results.csv")


plot_interitem <- function(dat, title) {
  dat %>% 
    ggplot(aes(x = startTime, y = windowLength, fill = interitem)) +
      geom_raster() +
      theme_bw() +
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
      coord_equal() + 
      scale_fill_gradient2(low = "blue", mid = "white", high = "red") +
      xlab("Start Time (ms)") +
      ylab("Window Length (ms)") +
      facet_wrap( ~ age_binned)
      ggtitle(title) 
}

```


Visualize inter-item correlation (per-subject, dataset, and age-bin) as a function of start time and window length.


```{r visualize-all-dat, fig.width=13, fig.height=5, echo=F}
plot_interitem(mout, "Inter-item Correlations")
```
