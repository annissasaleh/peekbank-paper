---
title: "Time Window Analysis"
author: "windowing team"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Motivation

[Peelle and Van Engen (2020)](https://psyarxiv.com/pc3da/) style multiverse analysis considering possible time windows with logistic growth curve models in a dataset with words of varying frequency, stimuli with varying levels of noise, and with young or old adults. 

```{r load-data, echo=F, message=F, warning=F}
# get local copy by running peekbank_explore.Rmd
load("data/aoi_data_joined.Rds") 
# change t_range upper limit to 4000 for full window analysis

library(tidyverse)
library(tictoc)
library(langcog)
library(here)
library(doParallel)
library(foreach)
library(ggpubr)

RUN_MODELS = FALSE
```

For our analysis, we will restrict ourselves to familiar words, and will model age effects.

```{r}
fam_data <- aoi_data_joined %>%
  filter(age > 12, age <= 60, 
         stimulus_novelty == "familiar") %>%
  mutate(age_binned = cut(age, seq(0,60,12))) 

rm(aoi_data_joined)
```


## Run Window Models


```{r, eval=RUN_MODELS}
# t_norm = [-1000,4000] 
get_alpha <- function (df) {
                    dfw <- pivot_wider(df,
                                       names_from = english_stimulus_label,
                                       values_from = prop_corr) %>%
                      select(-administration_id)
                    alphas <- psych::alpha(dfw)
                    return(alphas$total$raw_alpha)
}

# inter-item correlations
get_interitem <- function (df) {
   dfw <- pivot_wider(df,
                      names_from = english_stimulus_label,
                      values_from = prop_corr) %>%
     ungroup() %>%
     select(-administration_id)
   corrs <- corrr::correlate(dfw)
   mean_corr <- mean(rowMeans(select(corrs, -term), na.rm=TRUE), na.rm=TRUE)
   rm(corrs)
   return(mean_corr)
}




numCores <- detectCores() - 1
cl <- makeCluster(numCores)
registerDoParallel(cores=numCores)

mout <- foreach(i = 1:nrow(param.grid), .combine='bind_rows',
                .packages = c("corrr","tidyverse")) %dopar% {
                  if(i%%800==0) gc() # clean up memory a bit
                  fam_data %>% filter(t_norm > param.grid$startTimes[i], 
                                      t_norm < param.grid$endTimes[i]) %>%
                    group_by(dataset_name, age_binned, administration_id, english_stimulus_label) %>%
                    summarise(prop_corr = sum(aoi == "target") /
                                sum(aoi %in% c("target", "distractor"))) %>%
                    group_by(dataset_name, age_binned) %>%
                    nest() %>%
                    mutate(interitem =  lapply(data, quietly(get_interitem)),
                           interitem = interitem[[1]]$result) %>%
                    select(-data) %>%
                    unnest(cols = "interitem") %>%
                    group_by(age_binned) %>%
                    summarise(mean = mean(interitem, na.rm=TRUE)) %>%
                    mutate(startTime = param.grid$startTimes[i],
                           endTime = param.grid$endTimes[i])
} 
  
write.table(mout, file="data/time-window-results.csv")

stopCluster(cl)
```

```{r tidy-version}
require(purrr)

# Time bins are 25 ms 
startTs <- seq(from = -300, to = 1500, by = 50) 
# could use min(pb datasets min time) and max(pb datasets max time)
#windowLengths <- seq(from = 300, to = 2500, by = 25)
endTs <- seq(from = 0, to = 4000, by = 50)

param.grid <- crossing(startTs, endTs)
names(param.grid) = c("startTimes", "endTimes")

do_interitem_analysis <- function(startTime, endTime) {
      fam_data %>% filter(t_norm > startTime, 
                          t_norm < endTime) %>%
         group_by(dataset_name, age_binned, administration_id, english_stimulus_label) %>%
         summarise(prop_corr = sum(aoi == "target") /
                      sum(aoi %in% c("target", "distractor"))) %>%
         group_by(dataset_name, age_binned) %>%
         nest() %>%
         mutate(interitem =  lapply(data, quietly(get_interitem)),
                interitem = interitem[[1]]$result) %>%
         select(-data) %>%
         unnest(cols = "interitem") %>%
         group_by(age_binned) %>%
         summarise(mean = mean(interitem, na.rm=TRUE)) %>%
         mutate(startTime = startTime,
                endTime = endTime)
}

# this works
do_interitem_analysis(-300, 0)

# this should work
mout <- map2_df(param.grid$startTimes, param.grid$endTimes, 
             do_interitem_analysis)
# Unknown or uninitialised column: `startTimes`.Unknown or uninitialised column: `endTimes`.

mout <- param.grid %>% map2_df(startTimes, endTimes, 
             do_interitem_analysis)
# Error in as_mapper(.f, ...) : object 'endTimes' not found

mout <- param.grid %>% walk2(startTimes, endTimes, 
             do_interitem_analysis)

write.table(mout, file="data/time-window-results.csv")             

```


## Visualization 

```{r load-model-results, echo=F}
# all data
mout <- read.table(file="data/time-window-results.csv")


plot_interitem <- function(dat, title) {
  dat %>% 
    ggplot(aes(x = startTime, y = windowLength, fill = mean)) +
      geom_raster() +
      theme_bw() +
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
      coord_equal() + 
      scale_fill_gradient2(low = "blue", mid = "white", high = "red") +
      xlab("Start Time (ms)") +
      ylab("End Time (ms)") +
      facet_wrap( ~ age_binned) +
      ggtitle(title) 
}

```


Visualize inter-item correlation (per-subject, dataset, and age-bin) as a function of start time and window length.


```{r visualize-start-window-length, fig.width=9, fig.height=8, echo=F}
plot_interitem(mout, "Inter-item Correlations")
```

```{r visualize-start-stop, fig.width=9, fig.height=8, echo=F}
plot_interitem_start_stop_time(mout, "Inter-item Correlations")
```